<html>

<head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.5"> </script>

    <!-- Place your code in the script tag below. You can also use an external .js file -->
    <script>
        // Notice there is no 'import' statement. 'tf' is available on the index-page
        // because of the script tag above.

        // Define a model for linear regression.


        // Generate some synthetic data for training.


        // Train the model using the data.


    </script>
</head>

<body>



    <canvas id="myCanvas" width="500" height="500" style="border:1px solid #d3d3d3;">
        Your browser does not support the HTML5 canvas tag.</canvas>

        <button onclick="stopLearning()">stop learning from me</button>

    <script>

        const model = tf.sequential(tf.regularizers.l1);
        model.add(tf.layers.dense({ units: 10, inputShape: [2] }));
        model.add(tf.layers.dense({ units: 2 }));
        // Prepare the model for training: Specify the loss and the optimizer.
        model.compile({ loss: 'meanSquaredError', optimizer: 'sgd' });

        function trainModel(x, y, cb) {
            const xs = tf.tensor2d(x);
            const ys = tf.tensor2d(y);

            model.fit(xs, ys, { epochs: 100 }).then(() => {
                // Use the model to do inference on a data point the model hasn't seen before:
                // Open the browser devtools to see the output
                console.log('new model trained');
                model.predict(tf.tensor2d([0.5, 0.5], [1, 2])).print();
                if (learn){
                    cb(savedX, savedY, trainModel);
                }
            });
        }

        function predict(x) {
            const pred = model.predict(tf.tensor2d([x[0], x[1]], [1, 2])).dataSync()
            return { 'x': pred[0] * 500, 'y': pred[1] * 500 };
        }
        
        var learn = true;
        function stopLearning(){
            console.log('stoped learning');
            learn = false;
        }


        var savedX = []
        var savedY = []

        var c = document.getElementById("myCanvas");
        var ctx = c.getContext("2d");
        ctx.beginPath();
        ctx.arc(100, 75, 50, 0, 2 * Math.PI);
        ctx.stroke();

        var circlePos = { 'x': 75, 'y': 100 }

        var xInc = 2;
        var yInc = 2;

        var mousePos = { 'x': 0, 'y': 0 };

        var aiPos = { 'x': 0, 'y': 0 };

        function drawCrossHairs(pos) {
            ctx.beginPath();
            ctx.moveTo(0, pos.y);
            ctx.lineTo(500, pos.y);
            ctx.moveTo(pos.x, 0);
            ctx.lineTo(pos.x, 500);
            ctx.stroke();
        }

        var epoc = 0;
        var collect = 10;
        var grace = false;

        function reTrain(){
            grace = true;
            trainModel(savedX, savedY, trainModel);

        }



        function draw() {


            ctx.clearRect(0, 0, 500, 500);

            ctx.beginPath();
            if (circlePos.x > 500)  {
                xInc = -((Math.random() * 2) + 1);
            }else if (circlePos.x < 0){
                xInc = (Math.random() * 2) + 1;
            }

            if (circlePos.y > 500)  {
                yInc = -((Math.random() * 2) + 1);
            }else if (circlePos.y < 0){
                yInc = (Math.random() * 2) + 1;
            }


            circlePos.x += xInc
            circlePos.y += yInc

            ctx.arc(circlePos.x, circlePos.y, 50, 0, 2 * Math.PI);
            ctx.stroke();

            drawCrossHairs(mousePos)

            epoc++;

            if (epoc > collect) {
                epoc = 0;
                savedX.unshift([circlePos.x / 500, circlePos.y / 500])
                savedY.unshift([mousePos.x / 500, mousePos.y / 500])

                if (savedX.length > 150) {
                    savedX.pop()
                    savedY.pop()
                }
            }

            aiPos = predict([circlePos.x / 500, circlePos.y / 500])
            ctx.strokeStyle = "#8c8cff";
            drawCrossHairs(aiPos)
            ctx.strokeStyle = "#000000";


            window.requestAnimationFrame(draw);
        }

        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        c.addEventListener("mousemove", function (evt) {
            mousePos = getMousePos(c, evt);
        });

        setTimeout(reTrain, 3000);
        


        window.requestAnimationFrame(draw)

    </script>
</body>

</html>